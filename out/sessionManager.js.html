<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: sessionManager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: sessionManager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const uuid = require('uuid');
const { Session } = require('./session');
// Each session contains the username of the user and the time at which it expires
//  This object can be extended to store additional protected session information
class SessionManager {
    /**
     * Represents the session manager
     * @constructor
     */
    constructor(){
        this.sessions = {};
        this.currentUser = {};
        this.DEBUG = false;
    }
    /**
     * Creates a session
     * @param {string} username 
     * @param {number} numMinutes 
     * @returns {number} session ID
     */
    createSession(username, numMinutes) {
        // Generate a random UUID as the sessionId
        const sessionId = uuid.v4()
        // Set the expiry time as numMinutes (in milliseconds) after the current time
        const expiresAt = new Date(Date.now() + numMinutes * 60000);
    
        // Create a session object containing information about the user and expiry time
        const thisSession = new Session(username, expiresAt);
        
        // Add the session information to the sessions map, using sessionId as the key
        this.sessions[sessionId] = thisSession;
        return sessionId;
    }
    /**
     * Authenticates the user
     * @param {Object} request 
     * @returns session and user ID
     */
    authenticateUser(request) {
        // If this request doesn't have any cookies, that means it isn't authenticated. Return null.
        if (!request.cookies) {
            return null;
        }
        // We can obtain the session token from the requests cookies, which come with every request
        const sessionId = request.cookies['sessionId']
        if (!sessionId) {
            // If the cookie is not set, return null
            return null;
        }
        // We then get the session of the user from our session map
        var userSession = this.sessions[sessionId]
        if (!userSession) {
            return null;
        }        // If the session has expired, delete the session from our map and return null
        if (userSession.isExpired()) {
            delete this.sessions[sessionId];
            return null;
        }
        return { sessionId, userSession }; // Successfully validated.
    }
    /**
     * Refreshes the session by creating a new session
     * @param {Object} request 
     * @param {Object} response 
     * @returns new Session ID
     */
    refreshSession(request, response){
        const authenticatedSession = authenticateUser(request);
        if (!authenticatedSession) {
            response.sendStatus(401); // Unauthorized access
            return;
        }
        // Create and store a new Session object that will expire in 2 minutes.
        const newSessionId = createSession(authenticatedSession.userSession.username, 2);
        // Delete the old entry in the session map 
        delete this.sessions[authenticatedSession.sessionId];
        
        // Set the session cookie to the new id we generated, with a
        // renewed expiration time
        response.cookie("sessionId", newSessionId, { expires: this.sessions[newSessionId].expiresAt })
        return newSessionId;
    
    }
}

const sessionManager = new SessionManager();

module.exports = {
    SessionManager,
    sessionManager
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Session.html">Session</a></li><li><a href="SessionManager.html">SessionManager</a></li></ul><h3>Global</h3><ul><li><a href="global.html#isEmpty">isEmpty</a></li><li><a href="global.html#isValid">isValid</a></li><li><a href="global.html#validText">validText</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Fri May 20 2022 17:12:19 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
